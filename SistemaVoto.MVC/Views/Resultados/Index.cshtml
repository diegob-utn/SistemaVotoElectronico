@using SistemaVoto.MVC.Services
@using SistemaVoto.MVC.Controllers
@model ResultadosViewModel
@{
    ViewData["Title"] = "Resultados - " + Model.Eleccion.Titulo;
}

<div class="resultados-container">
    <!-- Header -->
    <div class="resultados-header">
        <div>
            <a href="/Elecciones" class="btn btn-ghost btn-sm">
                <i data-lucide="arrow-left" style="width: 18px; height: 18px;"></i>
                Volver
            </a>
            <h1>@Model.Eleccion.Titulo</h1>
            <p class="text-muted">Resultados electorales</p>
        </div>
        <div class="header-actions">
            <a href="/Resultados/ExportarCsv/@Model.Eleccion.Id" class="btn btn-secondary">
                <i data-lucide="download" style="width: 18px; height: 18px;"></i>
                Exportar CSV
            </a>
        </div>
    </div>

    <!-- Stats -->
    @if (Model.Resultados != null)
    {
        <div class="stats-row">
            <div class="stat-card glass-card">
                <div class="stat-card-icon" style="background: rgba(var(--accent-rgb), 0.15);">
                    <i data-lucide="vote" style="width: 24px; height: 24px; color: var(--accent);"></i>
                </div>
                <div class="stat-card-value">@Model.Resultados.TotalVotos.ToString("N0")</div>
                <div class="stat-card-label">Total Votos</div>
            </div>
            <div class="stat-card glass-card">
                <div class="stat-card-icon" style="background: rgba(134, 179, 0, 0.15);">
                    <i data-lucide="users" style="width: 24px; height: 24px; color: var(--color-success);"></i>
                </div>
                <div class="stat-card-value">@Model.Resultados.Candidatos.Count</div>
                <div class="stat-card-label">Candidatos</div>
            </div>
            @if (Model.Eleccion.NumEscanos > 0)
            {
                <div class="stat-card glass-card">
                    <div class="stat-card-icon" style="background: rgba(163, 122, 204, 0.15);">
                        <i data-lucide="armchair" style="width: 24px; height: 24px; color: var(--color-purple);"></i>
                    </div>
                    <div class="stat-card-value">@Model.Eleccion.NumEscanos</div>
                    <div class="stat-card-label">Escanos</div>
                </div>
            }
        </div>
    }

    <!-- Charts Grid -->
    <div class="charts-grid">
        <!-- Bar Chart -->
        <div class="card">
            <div class="card-header">
                @{
                    var tituloGrafico = (Model.Resultados?.Listas != null && Model.Resultados.Listas.Any()) 
                                        ? "Votos por Lista" 
                                        : "Votos por Candidato";
                }
                <h4 class="card-title">@tituloGrafico</h4>
            </div>
            <div class="card-body">
                <div id="chartResultados"></div>
            </div>
        </div>

        <!-- Pie Chart -->
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">Distribucion de Votos</h4>
            </div>
            <div class="card-body">
                <div id="chartDistribucion"></div>
            </div>
        </div>
    </div>

    <!-- Distribucion de Escanos -->
    @if (Model.DistribucionDHondt != null && Model.DistribucionDHondt.Any())
    {
        <div class="escanos-section">
            <h2 class="section-title">
                <i data-lucide="armchair" style="width: 24px; height: 24px;"></i>
                Distribución de Escaños (Proyección)
            </h2>
            
            <div class="escanos-comparison-grid">
                <!-- Columna D'Hondt -->
                <div class="metodo-card">
                    <div class="metodo-header">
                        <h3>Método D'Hondt</h3>
                        <div class="metodo-badge favorable-grandes">Favorece mayorías</div>
                    </div>
                    
                    <div class="metodo-info glass-panel">
                        <p><strong>Fórmula:</strong> División sucesiva (1, 2, 3...)</p>
                        <p class="text-xs text-muted">Tiende a favorecer a partidos grandes; reduce la fragmentación parlamentaria.</p>
                    </div>

                    <!-- Resumen Escaños -->
                    <div class="escanos-grid">
                        @if (Model.DetalleDHondt != null)
                        {
                            @foreach (var fila in Model.DetalleDHondt.Filas.OrderByDescending(f => f.EscanosTotales))
                            {
                                <div class="escano-card glass-card @(fila.EscanosTotales > 0 ? "ganador" : "sin-escanos")">
                                    <div class="escano-value">@fila.EscanosTotales</div>
                                    <div class="escano-label">@fila.Partido</div>
                                    <div class="escano-bar" style="width: @(Model.Eleccion.NumEscanos > 0 ? fila.EscanosTotales * 100.0 / Model.Eleccion.NumEscanos : 0)%"></div>
                                </div>
                            }
                        }
                        else
                        {
                           <!-- Fallback legacy if details missing (should not happen) -->
                            @foreach (var item in Model.DistribucionDHondt)
                            {
                                <div class="escano-card glass-card">
                                    <div class="escano-value">@item.Escanos</div>
                                    <div class="escano-label">@item.Nombre</div>
                                </div>
                            }
                        }
                    </div>

                    <!-- Detalle Calculo (Tabla) -->
                    @if (Model.DetalleDHondt != null && Model.DetalleDHondt.Filas.Any())
                    {
                        <div class="detalle-calculo mt-4">
                            <h4 class="text-sm font-bold mb-2 text-muted">Tabla de Cocientes</h4>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered text-xs">
                                    <thead>
                                        <tr>
                                            <th>Partido</th>
                                            <th>Votos</th>
                                            @for (int i = 0; i < Math.Min(5, Model.Eleccion.NumEscanos); i++)
                                            {
                                                <th>/@(i + 1)</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var fila in Model.DetalleDHondt.Filas)
                                        {
                                            <tr>
                                                <td class="font-bold">@fila.Partido</td>
                                                <td>@fila.Votos.ToString("N0")</td>
                                                @for (int i = 0; i < Math.Min(5, fila.ColCocientes.Count); i++)
                                                {
                                                    var c = fila.ColCocientes[i];
                                                    <td class="@(c.EsGanador ? "bg-accent-low text-accent font-bold" : "")" title="Orden: @(c.EsGanador ? c.OrdenAsignacion : "-")">
                                                        @c.Valor.ToString("N0")
                                                        @if(c.EsGanador) { <span class="badge-orden">#@c.OrdenAsignacion</span> }
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Lista Ordenada -->
                            <div class="mt-3">
                                <h4 class="text-sm font-bold mb-2 text-muted">Orden de Asignación</h4>
                                <div class="orden-asignacion-list">
                                    @foreach (var c in Model.DetalleDHondt.CocientesGanadores.OrderBy(x => x.OrdenAsignacion))
                                    {
                                        <div class="orden-item">
                                            <span class="orden-num">#@c.OrdenAsignacion</span>
                                            <span class="orden-partido">@c.Partido</span>
                                            <span class="orden-valor">(@c.Valor.ToString("N0"))</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
                
                <!-- Columna Webster -->
                <div class="metodo-card">
                    <div class="metodo-header">
                        <h3>Método Webster</h3>
                        <div class="metodo-badge favorable-proporcional">Más proporcional</div>
                    </div>
                    
                    <div class="metodo-info glass-panel">
                        <p><strong>Fórmula:</strong> Divisores impares (1, 3, 5...)</p>
                        <p class="text-xs text-muted">Beneficia a partidos medianos/pequeños; reduce la sobrerrepresentación.</p>
                    </div>

                    <!-- Resumen Escaños -->
                    <div class="escanos-grid">
                        @if (Model.DetalleWebster != null)
                        {
                            @foreach (var fila in Model.DetalleWebster.Filas.OrderByDescending(f => f.EscanosTotales))
                            {
                                <div class="escano-card glass-card @(fila.EscanosTotales > 0 ? "ganador" : "sin-escanos")">
                                    <div class="escano-value">@fila.EscanosTotales</div>
                                    <div class="escano-label">@fila.Partido</div>
                                    <div class="escano-bar" style="width: @(Model.Eleccion.NumEscanos > 0 ? fila.EscanosTotales * 100.0 / Model.Eleccion.NumEscanos : 0)%"></div>
                                </div>
                            }
                        }
                        else if (Model.DistribucionWebster != null)
                        {
                            @foreach (var item in Model.DistribucionWebster)
                            {
                                <div class="escano-card glass-card">
                                    <div class="escano-value">@item.Escanos</div>
                                    <div class="escano-label">@item.Nombre</div>
                                </div>
                            }
                        }
                    </div>

                    <!-- Detalle Calculo (Tabla) -->
                    @if (Model.DetalleWebster != null && Model.DetalleWebster.Filas.Any())
                    {
                        <div class="detalle-calculo mt-4">
                            <h4 class="text-sm font-bold mb-2 text-muted">Tabla de Cocientes</h4>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered text-xs">
                                    <thead>
                                        <tr>
                                            <th>Partido</th>
                                            <th>Votos</th>
                                            @for (int i = 0; i < Math.Min(5, Model.Eleccion.NumEscanos); i++)
                                            {
                                                <th>/@(2 * i + 1)</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var fila in Model.DetalleWebster.Filas)
                                        {
                                            <tr>
                                                <td class="font-bold">@fila.Partido</td>
                                                <td>@fila.Votos.ToString("N0")</td>
                                                @for (int i = 0; i < Math.Min(5, fila.ColCocientes.Count); i++)
                                                {
                                                    var c = fila.ColCocientes[i];
                                                    <td class="@(c.EsGanador ? "bg-accent-low text-accent font-bold" : "")" title="Orden: @(c.EsGanador ? c.OrdenAsignacion : "-")">
                                                        @c.Valor.ToString("N0")
                                                        @if(c.EsGanador) { <span class="badge-orden">#@c.OrdenAsignacion</span> }
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Lista Ordenada -->
                            <div class="mt-3">
                                <h4 class="text-sm font-bold mb-2 text-muted">Orden de Asignación</h4>
                                <div class="orden-asignacion-list">
                                    @foreach (var c in Model.DetalleWebster.CocientesGanadores.OrderBy(x => x.OrdenAsignacion))
                                    {
                                        <div class="orden-item">
                                            <span class="orden-num">#@c.OrdenAsignacion</span>
                                            <span class="orden-partido">@c.Partido</span>
                                            <span class="orden-valor">(@c.Valor.ToString("N0"))</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Detailed Results Table -->
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h4 class="card-title">Resultados Detallados</h4>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Posicion</th>
                        <th>Candidato</th>
                        <th>Partido</th>
                        <th>Votos</th>
                        <th>Porcentaje</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Resultados?.Listas != null && Model.Resultados.Listas.Any())
                    {
                        <tr><td colspan="5" class="text-center"><strong>Resultados por Lista</strong></td></tr>
                        var posicion = 1;
                        foreach (var lista in Model.Resultados.Listas)
                        {
                            <tr>
                                <td>@posicion</td>
                                <td>@lista.Nombre</td>
                                <td>-</td>
                                <td><strong>@lista.Votos.ToString("N0")</strong></td>
                                <td>
                                    <div class="progress-cell">
                                        <div class="progress-bar" style="width: @lista.Porcentaje%"></div>
                                        <span>@lista.Porcentaje.ToString("F1")%</span>
                                    </div>
                                </td>
                            </tr>
                            posicion++;
                        }
                         <tr><td colspan="5" class="text-center"><strong>Resultados por Candidato</strong></td></tr>
                    }

                    @if (Model.Resultados?.Listas != null && Model.Resultados.Listas.Any())
                    {
                        <tr><td colspan="5" class="text-center"><strong>Resultados por Lista</strong></td></tr>
                        var posicion = 1;
                        foreach (var lista in Model.Resultados.Listas)
                        {
                            <tr>
                                <td>@posicion</td>
                                <td>@lista.Nombre</td>
                                <td>-</td>
                                <td><strong>@lista.Votos.ToString("N0")</strong></td>
                                <td>
                                    <div class="progress-cell">
                                        <div class="progress-bar" style="width: @lista.Porcentaje%"></div>
                                        <span>@lista.Porcentaje.ToString("F1")%</span>
                                    </div>
                                </td>
                            </tr>
                            posicion++;
                        }
                         <tr><td colspan="5" class="text-center"><strong>Resultados por Candidato</strong></td></tr>
                    }

                    @if (Model.Resultados?.Candidatos != null)
                    {
                        var posicion = 1;
                        @foreach (var candidato in Model.Resultados.Candidatos.OrderByDescending(c => c.Votos))
                        {
                            <tr>
                                <td>
                                    @if (posicion == 1)
                                    {
                                        <span class="badge badge-accent">1ro</span>
                                    }
                                    else if (posicion == 2)
                                    {
                                        <span class="badge badge-info">2do</span>
                                    }
                                    else if (posicion == 3)
                                    {
                                        <span class="badge badge-warning">3ro</span>
                                    }
                                    else
                                    {
                                        <span>@posicion</span>
                                    }
                                </td>
                                <td>@candidato.Nombre</td>
                                <td>@candidato.PartidoPolitico</td>
                                <td><strong>@candidato.Votos.ToString("N0")</strong></td>
                                <td>
                                    <div class="progress-cell">
                                        <div class="progress-bar" style="width: @candidato.Porcentaje%"></div>
                                        <span>@candidato.Porcentaje.ToString("F1")%</span>
                                    </div>
                                </td>
                            </tr>
                            posicion++;
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .resultados-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .resultados-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
    }
    
    .resultados-header h1 {
        margin: 0.5rem 0 0;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    #chartResultados,
    #chartDistribucion {
        min-height: 350px;
    }
    
    .section-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 2rem;
        font-size: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem;
    }
    
    .escanos-comparison-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .metodo-card {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .metodo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .metodo-header h3 {
        margin: 0;
        font-size: 1.25rem;
        color: var(--text-primary);
    }

    .metodo-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 99px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metodo-badge.favorable-grandes {
        background: rgba(255, 159, 28, 0.15); /* Orange tint */
        color: #ff9f1c;
        border: 1px solid rgba(255, 159, 28, 0.3);
    }

    .metodo-badge.favorable-proporcional {
        background: rgba(46, 196, 182, 0.15); /* Teal tint */
        color: #2ec4b6;
        border: 1px solid rgba(46, 196, 182, 0.3);
    }
    
    .metodo-info {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--border-radius-sm);
        border-left: 3px solid var(--border-color);
    }

    .metodo-info p {
        margin: 0;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .metodo-info p:last-child {
        margin-bottom: 0;
    }

    .escanos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
    }
    
    .escano-card {
        padding: 1.25rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    
    .escano-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent);
    }
    
    .escano-label {
        color: var(--text-secondary);
        font-size: 0.9375rem;
    }
    
    .escano-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 4px;
        background: var(--accent);
        transition: width var(--transition-normal);
    }
    
    .progress-cell {
        position: relative;
        min-width: 100px;
    }
    
    .progress-bar {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 20px;
        background: rgba(var(--accent-rgb), 0.2);
        border-radius: 10px;
    }
    
    .progress-cell span {
        position: relative;
        z-index: 1;
    }
    
    @@media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @@media (max-width: 768px) {
        .stats-row {
            grid-template-columns: 1fr;
        }
        
        .resultados-header {
            flex-direction: column;
            gap: 1rem;
        }

        .escanos-comparison-grid {
            grid-template-columns: 1fr;
            gap: 3rem;
        }
    }

    /* Estilos para Tablas de Detalle */
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 1rem;
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--border-color);
        background: rgba(255, 255, 255, 0.02);
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        color: var(--text-primary);
        font-size: 0.85rem;
    }
    
    .table th, .table td {
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        text-align: center;
        white-space: nowrap;
    }
    
    .table th {
        background: rgba(255, 255, 255, 0.05);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
    }
    
    .bg-accent-low {
        background: rgba(var(--accent-rgb), 0.15) !important;
        color: var(--accent) !important;
    }
    
    .badge-orden {
        display: inline-block;
        padding: 0.1rem 0.3rem;
        font-size: 0.6rem;
        background: var(--accent);
        color: #0b0e14;
        border-radius: 4px;
        margin-left: 0.25rem;
        vertical-align: super;
        line-height: 1;
        font-weight: bold;
    }
    
    .orden-asignacion-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .orden-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.35rem;
        transition: all 0.2s ease;
    }
    
    .orden-item:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--text-secondary);
    }
    
    .orden-num {
        font-weight: 800;
        color: var(--accent);
    }
    
    .orden-valor {
        color: var(--text-muted);
        font-size: 0.7rem;
    }
    
    .escano-card.sin-escanos {
        opacity: 0.5;
        border-style: dashed;
    }
    
    .escano-card.ganador {
        border-color: var(--accent);
        background: rgba(var(--accent-rgb), 0.05);
    }
</style>

@section Scripts {
    <script src="~/js/apexcharts-config.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initCharts();
        });
        
        function initCharts() {
            @if (Model.Resultados != null)
            {
                object listasData = Model.Resultados.Listas?.Select(l => new { 
                        id = l.Id,
                        nombre = l.Nombre, 
                        votos = l.Votos, 
                        porcentaje = l.Porcentaje,
                        tipo = "Lista"
                    }).ToList();
                if (listasData == null) listasData = new List<object>();

                object candidatosData = Model.Resultados.Candidatos?.Select(c => new { 
                        id = c.Id,
                        nombre = c.Nombre, 
                        votos = c.Votos, 
                        porcentaje = c.Porcentaje,
                        tipo = "Candidato"
                    }).ToList();
                if (candidatosData == null) candidatosData = new List<object>();
                
                // Serializamos ambos
                var jsonListas = System.Text.Json.JsonSerializer.Serialize(listasData);
                var jsonCandidatos = System.Text.Json.JsonSerializer.Serialize(candidatosData);
                var tipoEleccion = Model.Eleccion.Tipo.ToString(); 

                // Pie Chart Logic


                <text>
                var dataListas = @Html.Raw(jsonListas);
                var dataCandidatos = @Html.Raw(jsonCandidatos);
                var tipoEleccion = '@Html.Raw(tipoEleccion)';

                // Generación dinámica de colores para asegurar unicidad
                var totalEntities = dataListas.length + dataCandidatos.length;
                
                // Función para general colores visualmente distintos usando el Ángulo Áureo
                function getDistinctColor(index) {
                    var hue = (index * 137.508) % 360; 
                    return `hsl(${hue}, 70%, 50%)`; 
                }

                // Formateador robusto para eliminar sufijo interno
                function formatUniqueName(val) {
                    if (val === null || val === undefined) return "";
                    var str = String(val);
                    if (str.indexOf('__ID__') > -1) {
                        return str.split('__ID__')[0];
                    }
                    return str;
                }

                function makeNamesUnique(data) {
                    // Usar ID para unicidad en lugar de contador
                    data.forEach((d, idx) => {
                        // Limpiar cualquier sufijo existente (por seguridad)
                        var baseName = "";
                        if(d.nombre && d.nombre.indexOf('__ID__') > -1) {
                             baseName = d.nombre.split('__ID__')[0];
                        } else {
                             baseName = d.nombre || ("Item " + idx);
                        }
                        
                        // Añadir ID como sufijo único (fallback a index si no hay ID)
                        var uniqueId = (d.id !== undefined && d.id !== null) ? d.id : ("idx" + idx);
                        d.nombre = baseName + "__ID__" + uniqueId;
                    });
                }

                // Asignar colores a Listas
                makeNamesUnique(dataListas);
                dataListas.forEach((d, i) => { 
                    d.color = getDistinctColor(i); 
                });
                
                // Continuar la secuencia de colores para Candidatos
                makeNamesUnique(dataCandidatos);
                var globalIndex = dataListas.length; 
                dataCandidatos.forEach((d, i) => { 
                    d.color = getDistinctColor(globalIndex + i); 
                });

                function renderChart(elementId, data, title) {
                    if (!data || data.length === 0) return;

                    var options = {
                        series: [{
                            name: 'Votos',
                            data: data.map(item => item.votos)
                        }],
                        chart: {
                            type: 'bar',
                            height: 300,
                            background: 'transparent',
                            toolbar: { show: false }
                        },
                        title: { 
                            text: title, 
                            align: 'left',
                            style: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() }
                        },
                        plotOptions: {
                            bar: {
                                horizontal: true,
                                borderRadius: 6,
                                distributed: true, 
                                dataLabels: { position: 'top' }
                            }
                        },
                        colors: data.map(item => item.color), 
                        dataLabels: {
                            enabled: true,
                            formatter: function(val) { return val.toLocaleString(); },
                            style: { fontSize: '12px' },
                            offsetX: 10
                        },
                        xaxis: {
                            categories: data.map(item => item.nombre),
                            labels: { 
                                style: { colors: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim() },
                                formatter: function(val) { return formatUniqueName(val); }
                            }
                        },
                        yaxis: {
                            labels: { 
                                style: { colors: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim() },
                                formatter: function(val) { return formatUniqueName(val); }
                            }
                        },
                        tooltip: {
                            x: {
                                formatter: function(val) { return formatUniqueName(val); }
                            }
                        },
                        legend: {
                            show: true,
                            position: 'bottom',
                            markers: { radius: 12 },
                            itemMargin: { horizontal: 10, vertical: 5 },
                            formatter: function(seriesName, opts) {
                                return formatUniqueName(seriesName);
                            }
                        },
                        grid: {
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()
                        },
                        theme: {
                            mode: document.documentElement.getAttribute('data-theme') || 'light'
                        }
                    };
                    var chart = new ApexCharts(document.querySelector(elementId), options);
                    chart.render();
                }

                // Logic for Mixta: Show BOTH if available
                // Logic for Plancha: Show Listas
                // Logic for Nominal: Show Candidatos

                // Clear previous content
                document.querySelector("#chartResultados").innerHTML = "";

                var chartContainer = document.querySelector("#chartResultados");
                
                if (dataListas.length > 0) {
                     var divListas = document.createElement("div");
                     divListas.id = "chartListas";
                     divListas.style.marginBottom = "20px";
                     chartContainer.appendChild(divListas);
                     
                     renderChart("#chartListas", dataListas, "Votos por Lista");
                }

                if (dataCandidatos.length > 0 && (tipoEleccion === 'Mixta' || tipoEleccion === 'Nominal' || dataListas.length === 0)) {
                     var divCandidatos = document.createElement("div");
                     divCandidatos.id = "chartCandidatos";
                     chartContainer.appendChild(divCandidatos);

                     renderChart("#chartCandidatos", dataCandidatos, "Votos por Candidato");
                }

                // Pie Chart Logic
                var pieData = [];
                if (tipoEleccion === 'Mixta') {
                    // Combine both for global distribution
                     pieData = dataListas.concat(dataCandidatos);
                } else {
                     // Default behavior: Prioritize Listas (Plancha), fallback to Candidates (Nominal)
                     pieData = (dataListas.length > 0) ? dataListas : dataCandidatos;
                }

                // Pila de errores silenciosa
                if (pieData && pieData.length > 0) {
                    var optionsPie = {
                        series: pieData.map(item => item.votos),
                        labels: pieData.map(item => item.nombre),
                        chart: {
                            type: 'donut',
                            height: 350,
                            background: 'transparent'
                        },
                        colors: pieData.map(item => item.color),
                        plotOptions: {
                            pie: {
                                donut: {
                                    size: '60%',
                                    labels: {
                                        show: true,
                                        name: {
                                            show: true,
                                            formatter: function (val) {
                                                return formatUniqueName(val);
                                            }
                                        },
                                        value: {
                                            show: true,
                                            formatter: function (val) {
                                                return parseInt(val);
                                            }
                                        },
                                        total: {
                                            show: true,
                                            label: 'Total',
                                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
                                            formatter: function (w) {
                                                return w.globals.seriesTotals.reduce((a, b) => {
                                                    return a + b
                                                }, 0)
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        tooltip: {
                            y: {
                                formatter: undefined,
                                title: {
                                    formatter: (seriesName) => formatUniqueName(seriesName) + ":", 
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: { colors: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() },
                            formatter: function(seriesName, opts) {
                                return formatUniqueName(seriesName) + " - " + opts.w.globals.series[opts.seriesIndex]; 
                            }
                        },
                        theme: {
                            mode: document.documentElement.getAttribute('data-theme') || 'light'
                        }
                    };
                    var chartPie = new ApexCharts(document.querySelector("#chartDistribucion"), optionsPie);
                    chartPie.render();
                }

                // ==========================================
                //  SIGNALR - REALTIME UPDATES
                // ==========================================
                try {
                    // Conectar al Hub en el puerto de la API (5049/7101)
                    // Ajusta el puerto si tu API corre en otro
                    var connection = new signalR.HubConnectionBuilder()
                        .withUrl("https://localhost:7101/hubs/votacion") 
                        .withAutomaticReconnect()
                        .build();

                    connection.on("ActualizacionResultados", function (id) {
                        var currentEleccionId = @Model.Eleccion.Id;
                        console.log("Evento recibido para eleccion: " + id);
                        
                        if (id == currentEleccionId) {
                            // Recargar solo si es la eleccion actual
                            location.reload(); 
                        }
                    });

                    connection.start().then(function () {
                        console.log("Conectado a SignalR Hub de Votación");
                        // Unirse al grupo de esta eleccion
                        connection.invoke("JoinGroup", @Model.Eleccion.Id).catch(function (err) {
                            return console.error(err.toString());
                        });
                    }).catch(function (err) {
                        console.error("Error al conectar SignalR: " + err.toString());
                    });

                } catch (e) {
                    console.error("Error inicializando SignalR", e);
                }
                </text>

            }
        }
    </script>
}
